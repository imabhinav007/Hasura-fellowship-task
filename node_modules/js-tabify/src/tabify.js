(function($) {
    function links(TabGroup) {
        return TabGroup.children('div.tab-links').find('ul.nav').children('li');
    }

    function content(TabGroup) {
        return TabGroup.children('div.tab-content').children('div.tab-pane');
    }

    // Add the click handler
    $('body').on('click', '.tabpanel ul.nav li, [role="tabpanel"] ul.nav li', function() {
        var link       = $(this);
        var TabGroup   = link.closest('.tabpanel, [role="tabpanel"]');
        var TabLinks   = links(TabGroup);
        var TabContent = content(TabGroup);

        if (!TabGroup.hasClass('tab-group-perm')) {
            if (!link.hasClass('active')) {
                var i = TabLinks.index(link);
                TabLinks.removeClass('active');
                TabContent.removeClass('active');
                link.addClass('active');
                TabContent.eq(i).addClass('active');
            }
            return false;
        }
    });
    // Set the default
    $('.tabpanel,[role="tabpanel"]').on('tabify:default', function() {
        var TabGroup = $(this);

        if (!TabGroup.hasClass('tab-group-perm')) {
            var TabLinks = links(TabGroup);

            var hash = window.location.hash.substr(1);
            if (hash && TabLinks.filter('#' + hash + 'Tab').length) {
                TabLinks.filter('#' + hash + 'Tab').eq(0).trigger('click');
            } else if (TabLinks.filter('.active').length) {
                TabLinks.filter('.active').eq(0).trigger('click');
            } else {
                TabLinks.eq(0).trigger('click');
            }
        }
    });

    $(document).ready(function() {
        $('.tabpanel,[role="tabpanel"]').trigger('tabify:default');
    });
})(jQuery);